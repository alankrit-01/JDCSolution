const express = require('express');
// const Web3 = require('web3');
const ethers = require('ethers');
require('dotenv').config()


const app = express();

var contractAbi={
  "_format": "hh-sol-artifact-1",
  "contractName": "Supplychain",
  "sourceName": "contracts/Supplychain.sol",
  "abi": [
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        },
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "name": "BatchIDToProductIDMapping",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "name": "BatchIDs",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "name": "BatchMapping",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "BatchID",
          "type": "uint256"
        },
        {
          "internalType": "uint256",
          "name": "BatchSize",
          "type": "uint256"
        },
        {
          "internalType": "uint256",
          "name": "AmountSold",
          "type": "uint256"
        },
        {
          "internalType": "string",
          "name": "BatchDescription",
          "type": "string"
        },
        {
          "internalType": "uint256",
          "name": "ProductTemplateID",
          "type": "uint256"
        },
        {
          "internalType": "address",
          "name": "Factory",
          "type": "address"
        },
        {
          "internalType": "address",
          "name": "Distributor",
          "type": "address"
        },
        {
          "internalType": "address",
          "name": "Retailer",
          "type": "address"
        },
        {
          "internalType": "string",
          "name": "FactoryLocation",
          "type": "string"
        },
        {
          "internalType": "string",
          "name": "DateOfProduction",
          "type": "string"
        },
        {
          "internalType": "uint256",
          "name": "state",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "name": "BatchTemplateIDs",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "name": "BatchTemplateMAP",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "batchTemplateID",
          "type": "uint256"
        },
        {
          "internalType": "uint256",
          "name": "productTemplateID",
          "type": "uint256"
        },
        {
          "internalType": "string",
          "name": "description",
          "type": "string"
        },
        {
          "internalType": "uint256",
          "name": "batchSize",
          "type": "uint256"
        },
        {
          "internalType": "address",
          "name": "factoryADDRESS",
          "type": "address"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "name": "ProductIDs",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "name": "ProductMapping",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "ProductID",
          "type": "uint256"
        },
        {
          "internalType": "uint256",
          "name": "ProductTemplateID",
          "type": "uint256"
        },
        {
          "internalType": "string",
          "name": "DOM",
          "type": "string"
        },
        {
          "internalType": "address",
          "name": "Owner",
          "type": "address"
        },
        {
          "internalType": "uint256",
          "name": "DateWhenSold",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "name": "ProductTemplateIDs",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "name": "ProductTemplateMAP",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "productTemplateID",
          "type": "uint256"
        },
        {
          "internalType": "string",
          "name": "name",
          "type": "string"
        },
        {
          "internalType": "string",
          "name": "description",
          "type": "string"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "_batchTemplateID",
          "type": "uint256"
        },
        {
          "internalType": "uint256",
          "name": "_productTemplateID",
          "type": "uint256"
        },
        {
          "internalType": "string",
          "name": "_description",
          "type": "string"
        },
        {
          "internalType": "uint256",
          "name": "_batchSize",
          "type": "uint256"
        },
        {
          "internalType": "address",
          "name": "_factoryADDRESS",
          "type": "address"
        }
      ],
      "name": "addBatchTemplate",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "_productTemplateID",
          "type": "uint256"
        },
        {
          "internalType": "string",
          "name": "_name",
          "type": "string"
        },
        {
          "internalType": "string",
          "name": "_description",
          "type": "string"
        }
      ],
      "name": "addProductTemplate",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "batchID",
          "type": "uint256"
        },
        {
          "internalType": "uint256[]",
          "name": "productIDs",
          "type": "uint256[]"
        },
        {
          "internalType": "uint256",
          "name": "batchSize",
          "type": "uint256"
        },
        {
          "internalType": "string",
          "name": "batchDescription",
          "type": "string"
        },
        {
          "internalType": "uint256",
          "name": "productTemplateID",
          "type": "uint256"
        },
        {
          "internalType": "address",
          "name": "factory",
          "type": "address"
        },
        {
          "internalType": "address",
          "name": "distributor",
          "type": "address"
        },
        {
          "internalType": "string",
          "name": "factoryLocation",
          "type": "string"
        },
        {
          "internalType": "string",
          "name": "dateOfProduction",
          "type": "string"
        }
      ],
      "name": "batchProduced",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "batchID",
          "type": "uint256"
        },
        {
          "internalType": "address",
          "name": "retailer",
          "type": "address"
        }
      ],
      "name": "distributorSellToRetailer",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "getAllBatchIDs",
      "outputs": [
        {
          "internalType": "uint256[]",
          "name": "",
          "type": "uint256[]"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "getAllBatchTemplateIDs",
      "outputs": [
        {
          "internalType": "uint256[]",
          "name": "",
          "type": "uint256[]"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "getAllProductIDs",
      "outputs": [
        {
          "internalType": "uint256[]",
          "name": "",
          "type": "uint256[]"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "getAllProductTemplateIDs",
      "outputs": [
        {
          "internalType": "uint256[]",
          "name": "",
          "type": "uint256[]"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "batchID",
          "type": "uint256"
        }
      ],
      "name": "getProductIdsForaBatch",
      "outputs": [
        {
          "internalType": "uint256[]",
          "name": "",
          "type": "uint256[]"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "batchID",
          "type": "uint256"
        },
        {
          "internalType": "uint256",
          "name": "productID",
          "type": "uint256"
        },
        {
          "internalType": "address",
          "name": "customer",
          "type": "address"
        }
      ],
      "name": "retailerSellToCustomer",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    }
  ],
  "bytecode": "0x608060405234801561001057600080fd5b50611627806100206000396000f3fe608060405234801561001057600080fd5b50600436106101215760003560e01c8063793560dd116100ad5780639247e9fd116100715780639247e9fd1461024a57806399ae96e214610293578063a78317f8146102a6578063bf801df1146102b9578063eac0e977146102e357600080fd5b8063793560dd146101f05780637ae4ee04146101f85780638bd428801461021c5780638c4c42cd1461022f57806390973cce1461023757600080fd5b80634c27729c116100f45780634c27729c1461018d5780634ca20f34146101955780634e939486146101a857806371d1dc0c146101bb578063759b8fba146101dd57600080fd5b806313e6bed914610126578063392a70a61461013b5780633ab95f30146101645780633b7d255c14610185575b600080fd5b610139610134366004610ee7565b610307565b005b61014e610149366004610f1c565b610369565b60405161015b9190610f35565b60405180910390f35b610177610172366004610f1c565b6103cb565b60405190815260200161015b565b61014e6103ec565b61014e610444565b6101776101a3366004610f1c565b61049a565b6101396101b6366004611030565b6104aa565b6101ce6101c9366004610f1c565b61053b565b60405161015b939291906110e3565b6101396101eb366004611198565b61066e565b61014e610918565b61020b610206366004610f1c565b61096e565b60405161015b959493929190611284565b61017761022a366004610f1c565b610a30565b61014e610a40565b6101776102453660046112c5565b610a96565b6101396102583660046112e7565b6000918252600660205260409091206007810180546001600160a01b0319166001600160a01b03909316929092179091556001600a90910155565b6101396102a1366004611313565b610ac7565b6101776102b4366004610f1c565b610b99565b6102cc6102c7366004610f1c565b610ba9565b60405161015b9b9a9998979695949392919061137e565b6102f66102f1366004610f1c565b610daa565b60405161015b95949392919061140e565b6000838152600660205260408120600201805460019290610329908490611460565b909155505060009182526004602081905260409092206003810180546001600160a01b0319166001600160a01b0393909316929092179091554291015550565b6000818152600760209081526040918290208054835181840281018401909452808452606093928301828280156103bf57602002820191906000526020600020905b8154815260200190600101908083116103ab575b50505050509050919050565b600281815481106103db57600080fd5b600091825260209091200154905081565b6060600280548060200260200160405190810160405280929190818152602001828054801561043a57602002820191906000526020600020905b815481526020019060010190808311610426575b5050505050905090565b6060600380548060200260200160405190810160405280929190818152602001828054801561043a5760200282019190600052602060002090815481526020019060010190808311610426575050505050905090565b600381815481106103db57600080fd5b60408051606081018252848152602080820185815282840185905260008781529182905292902081518155915190919060018201906104e99082611502565b50604082015160028201906104fe9082611502565b5050600280546001810182556000919091527f405787fa12a823e0f2b7631cc41b3ba8828b3321ca811111fa75cd3aa3bb5ace0193909355505050565b6000602081905290815260409020805460018201805491929161055d90611479565b80601f016020809104026020016040519081016040528092919081815260200182805461058990611479565b80156105d65780601f106105ab576101008083540402835291602001916105d6565b820191906000526020600020905b8154815290600101906020018083116105b957829003601f168201915b5050505050908060020180546105eb90611479565b80601f016020809104026020016040519081016040528092919081815260200182805461061790611479565b80156106645780601f1061063957610100808354040283529160200191610664565b820191906000526020600020905b81548152906001019060200180831161064757829003601f168201915b5050505050905083565b60408051610160810182528a815260208082018a81526000838501818152606085018c8152608086018c90526001600160a01b03808c1660a08801528a1660c087015260e086018390526101008601899052610120860188905261014086018390528f835260069094529490208351815590516001820155925160028401555190919060038201906107009082611502565b506080820151600482015560a08201516005820180546001600160a01b039283166001600160a01b03199182161790915560c084015160068401805491841691831691909117905560e084015160078401805491909316911617905561010082015160088201906107719082611502565b5061012082015160098201906107879082611502565b506101409190910151600a9091015560088054600181019091557ff3f7a9fe364faab93b216da50a3214154f22a0a2b415b23a84c8169e8b636ee301899055600089815260076020908152604090912089516107e5928b0190610e6b565b5060005b8781101561090c576040518060a001604052808a838151811061080e5761080e6115c2565b6020026020010151815260200187815260200183815260200160006001600160a01b031681526020016000815250600460008b8481518110610852576108526115c2565b60200260200101518152602001908152602001600020600082015181600001556020820151816001015560408201518160020190816108919190611502565b5060608201516003820180546001600160a01b0319166001600160a01b0390921691909117905560809091015160049091015588516005908a90839081106108db576108db6115c2565b6020908102919091018101518254600181018455600093845291909220015580610904816115d8565b9150506107e9565b50505050505050505050565b6060600880548060200260200160405190810160405280929190818152602001828054801561043a5760200282019190600052602060002090815481526020019060010190808311610426575050505050905090565b600160208190526000918252604090912080549181015460028201805491929161099790611479565b80601f01602080910402602001604051908101604052809291908181526020018280546109c390611479565b8015610a105780601f106109e557610100808354040283529160200191610a10565b820191906000526020600020905b8154815290600101906020018083116109f357829003601f168201915b5050505060038301546004909301549192916001600160a01b0316905085565b600881815481106103db57600080fd5b6060600580548060200260200160405190810160405280929190818152602001828054801561043a5760200282019190600052602060002090815481526020019060010190808311610426575050505050905090565b60076020528160005260406000208181548110610ab257600080fd5b90600052602060002001600091509150505481565b6040805160a0810182528681526020808201878152828401878152606084018790526001600160a01b038616608085015260008a8152600193849052949094208351815590519181019190915591519091906002820190610b289082611502565b506060820151600382810191909155608090920151600490910180546001600160a01b0319166001600160a01b0390921691909117905580546001810182556000919091527fc2575a0e9e593c00f959f8c92f12db2869c3395a3b0502d05e2516446f71f85b019490945550505050565b600581815481106103db57600080fd5b600660205260009081526040902080546001820154600283015460038401805493949293919291610bd990611479565b80601f0160208091040260200160405190810160405280929190818152602001828054610c0590611479565b8015610c525780601f10610c2757610100808354040283529160200191610c52565b820191906000526020600020905b815481529060010190602001808311610c3557829003601f168201915b5050506004840154600585015460068601546007870154600888018054979894976001600160a01b03948516975092841695509216929190610c9390611479565b80601f0160208091040260200160405190810160405280929190818152602001828054610cbf90611479565b8015610d0c5780601f10610ce157610100808354040283529160200191610d0c565b820191906000526020600020905b815481529060010190602001808311610cef57829003601f168201915b505050505090806009018054610d2190611479565b80601f0160208091040260200160405190810160405280929190818152602001828054610d4d90611479565b8015610d9a5780601f10610d6f57610100808354040283529160200191610d9a565b820191906000526020600020905b815481529060010190602001808311610d7d57829003601f168201915b50505050509080600a015490508b565b60046020526000908152604090208054600182015460028301805492939192610dd290611479565b80601f0160208091040260200160405190810160405280929190818152602001828054610dfe90611479565b8015610e4b5780601f10610e2057610100808354040283529160200191610e4b565b820191906000526020600020905b815481529060010190602001808311610e2e57829003601f168201915b50505050600383015460049093015491926001600160a01b031691905085565b828054828255906000526020600020908101928215610ea6579160200282015b82811115610ea6578251825591602001919060010190610e8b565b50610eb2929150610eb6565b5090565b5b80821115610eb25760008155600101610eb7565b80356001600160a01b0381168114610ee257600080fd5b919050565b600080600060608486031215610efc57600080fd5b8335925060208401359150610f1360408501610ecb565b90509250925092565b600060208284031215610f2e57600080fd5b5035919050565b6020808252825182820181905260009190848201906040850190845b81811015610f6d57835183529284019291840191600101610f51565b50909695505050505050565b634e487b7160e01b600052604160045260246000fd5b604051601f8201601f1916810167ffffffffffffffff81118282101715610fb857610fb8610f79565b604052919050565b600082601f830112610fd157600080fd5b813567ffffffffffffffff811115610feb57610feb610f79565b610ffe601f8201601f1916602001610f8f565b81815284602083860101111561101357600080fd5b816020850160208301376000918101602001919091529392505050565b60008060006060848603121561104557600080fd5b83359250602084013567ffffffffffffffff8082111561106457600080fd5b61107087838801610fc0565b9350604086013591508082111561108657600080fd5b5061109386828701610fc0565b9150509250925092565b6000815180845260005b818110156110c3576020818501810151868301820152016110a7565b506000602082860101526020601f19601f83011685010191505092915050565b8381526060602082015260006110fc606083018561109d565b828103604084015261110e818561109d565b9695505050505050565b600082601f83011261112957600080fd5b8135602067ffffffffffffffff82111561114557611145610f79565b8160051b611154828201610f8f565b928352848101820192828101908785111561116e57600080fd5b83870192505b8483101561118d57823582529183019190830190611174565b979650505050505050565b60008060008060008060008060006101208a8c0312156111b757600080fd5b8935985060208a013567ffffffffffffffff808211156111d657600080fd5b6111e28d838e01611118565b995060408c0135985060608c01359150808211156111ff57600080fd5b61120b8d838e01610fc0565b975060808c0135965061122060a08d01610ecb565b955061122e60c08d01610ecb565b945060e08c013591508082111561124457600080fd5b6112508d838e01610fc0565b93506101008c013591508082111561126757600080fd5b506112748c828d01610fc0565b9150509295985092959850929598565b85815284602082015260a0604082015260006112a360a083018661109d565b6060830194909452506001600160a01b03919091166080909101529392505050565b600080604083850312156112d857600080fd5b50508035926020909101359150565b600080604083850312156112fa57600080fd5b8235915061130a60208401610ecb565b90509250929050565b600080600080600060a0868803121561132b57600080fd5b8535945060208601359350604086013567ffffffffffffffff81111561135057600080fd5b61135c88828901610fc0565b9350506060860135915061137260808701610ecb565b90509295509295909350565b60006101608d83528c60208401528b60408401528060608401526113a48184018c61109d565b608084018b90526001600160a01b038a811660a086015289811660c0860152881660e085015283810361010085015290506113df818761109d565b90508281036101208401526113f4818661109d565b915050826101408301529c9b505050505050505050505050565b85815284602082015260a06040820152600061142d60a083018661109d565b6001600160a01b0394909416606083015250608001529392505050565b634e487b7160e01b600052601160045260246000fd5b808201808211156114735761147361144a565b92915050565b600181811c9082168061148d57607f821691505b6020821081036114ad57634e487b7160e01b600052602260045260246000fd5b50919050565b601f8211156114fd57600081815260208120601f850160051c810160208610156114da5750805b601f850160051c820191505b818110156114f9578281556001016114e6565b5050505b505050565b815167ffffffffffffffff81111561151c5761151c610f79565b6115308161152a8454611479565b846114b3565b602080601f831160018114611565576000841561154d5750858301515b600019600386901b1c1916600185901b1785556114f9565b600085815260208120601f198616915b8281101561159457888601518255948401946001909101908401611575565b50858210156115b25787850151600019600388901b60f8161c191681555b5050505050600190811b01905550565b634e487b7160e01b600052603260045260246000fd5b6000600182016115ea576115ea61144a565b506001019056fea264697066735822122017597645c0e99767450748ebe0fe04a3383ee48e027cd44a398925ae67703ce064736f6c63430008110033",
  "deployedBytecode": "0x608060405234801561001057600080fd5b50600436106101215760003560e01c8063793560dd116100ad5780639247e9fd116100715780639247e9fd1461024a57806399ae96e214610293578063a78317f8146102a6578063bf801df1146102b9578063eac0e977146102e357600080fd5b8063793560dd146101f05780637ae4ee04146101f85780638bd428801461021c5780638c4c42cd1461022f57806390973cce1461023757600080fd5b80634c27729c116100f45780634c27729c1461018d5780634ca20f34146101955780634e939486146101a857806371d1dc0c146101bb578063759b8fba146101dd57600080fd5b806313e6bed914610126578063392a70a61461013b5780633ab95f30146101645780633b7d255c14610185575b600080fd5b610139610134366004610ee7565b610307565b005b61014e610149366004610f1c565b610369565b60405161015b9190610f35565b60405180910390f35b610177610172366004610f1c565b6103cb565b60405190815260200161015b565b61014e6103ec565b61014e610444565b6101776101a3366004610f1c565b61049a565b6101396101b6366004611030565b6104aa565b6101ce6101c9366004610f1c565b61053b565b60405161015b939291906110e3565b6101396101eb366004611198565b61066e565b61014e610918565b61020b610206366004610f1c565b61096e565b60405161015b959493929190611284565b61017761022a366004610f1c565b610a30565b61014e610a40565b6101776102453660046112c5565b610a96565b6101396102583660046112e7565b6000918252600660205260409091206007810180546001600160a01b0319166001600160a01b03909316929092179091556001600a90910155565b6101396102a1366004611313565b610ac7565b6101776102b4366004610f1c565b610b99565b6102cc6102c7366004610f1c565b610ba9565b60405161015b9b9a9998979695949392919061137e565b6102f66102f1366004610f1c565b610daa565b60405161015b95949392919061140e565b6000838152600660205260408120600201805460019290610329908490611460565b909155505060009182526004602081905260409092206003810180546001600160a01b0319166001600160a01b0393909316929092179091554291015550565b6000818152600760209081526040918290208054835181840281018401909452808452606093928301828280156103bf57602002820191906000526020600020905b8154815260200190600101908083116103ab575b50505050509050919050565b600281815481106103db57600080fd5b600091825260209091200154905081565b6060600280548060200260200160405190810160405280929190818152602001828054801561043a57602002820191906000526020600020905b815481526020019060010190808311610426575b5050505050905090565b6060600380548060200260200160405190810160405280929190818152602001828054801561043a5760200282019190600052602060002090815481526020019060010190808311610426575050505050905090565b600381815481106103db57600080fd5b60408051606081018252848152602080820185815282840185905260008781529182905292902081518155915190919060018201906104e99082611502565b50604082015160028201906104fe9082611502565b5050600280546001810182556000919091527f405787fa12a823e0f2b7631cc41b3ba8828b3321ca811111fa75cd3aa3bb5ace0193909355505050565b6000602081905290815260409020805460018201805491929161055d90611479565b80601f016020809104026020016040519081016040528092919081815260200182805461058990611479565b80156105d65780601f106105ab576101008083540402835291602001916105d6565b820191906000526020600020905b8154815290600101906020018083116105b957829003601f168201915b5050505050908060020180546105eb90611479565b80601f016020809104026020016040519081016040528092919081815260200182805461061790611479565b80156106645780601f1061063957610100808354040283529160200191610664565b820191906000526020600020905b81548152906001019060200180831161064757829003601f168201915b5050505050905083565b60408051610160810182528a815260208082018a81526000838501818152606085018c8152608086018c90526001600160a01b03808c1660a08801528a1660c087015260e086018390526101008601899052610120860188905261014086018390528f835260069094529490208351815590516001820155925160028401555190919060038201906107009082611502565b506080820151600482015560a08201516005820180546001600160a01b039283166001600160a01b03199182161790915560c084015160068401805491841691831691909117905560e084015160078401805491909316911617905561010082015160088201906107719082611502565b5061012082015160098201906107879082611502565b506101409190910151600a9091015560088054600181019091557ff3f7a9fe364faab93b216da50a3214154f22a0a2b415b23a84c8169e8b636ee301899055600089815260076020908152604090912089516107e5928b0190610e6b565b5060005b8781101561090c576040518060a001604052808a838151811061080e5761080e6115c2565b6020026020010151815260200187815260200183815260200160006001600160a01b031681526020016000815250600460008b8481518110610852576108526115c2565b60200260200101518152602001908152602001600020600082015181600001556020820151816001015560408201518160020190816108919190611502565b5060608201516003820180546001600160a01b0319166001600160a01b0390921691909117905560809091015160049091015588516005908a90839081106108db576108db6115c2565b6020908102919091018101518254600181018455600093845291909220015580610904816115d8565b9150506107e9565b50505050505050505050565b6060600880548060200260200160405190810160405280929190818152602001828054801561043a5760200282019190600052602060002090815481526020019060010190808311610426575050505050905090565b600160208190526000918252604090912080549181015460028201805491929161099790611479565b80601f01602080910402602001604051908101604052809291908181526020018280546109c390611479565b8015610a105780601f106109e557610100808354040283529160200191610a10565b820191906000526020600020905b8154815290600101906020018083116109f357829003601f168201915b5050505060038301546004909301549192916001600160a01b0316905085565b600881815481106103db57600080fd5b6060600580548060200260200160405190810160405280929190818152602001828054801561043a5760200282019190600052602060002090815481526020019060010190808311610426575050505050905090565b60076020528160005260406000208181548110610ab257600080fd5b90600052602060002001600091509150505481565b6040805160a0810182528681526020808201878152828401878152606084018790526001600160a01b038616608085015260008a8152600193849052949094208351815590519181019190915591519091906002820190610b289082611502565b506060820151600382810191909155608090920151600490910180546001600160a01b0319166001600160a01b0390921691909117905580546001810182556000919091527fc2575a0e9e593c00f959f8c92f12db2869c3395a3b0502d05e2516446f71f85b019490945550505050565b600581815481106103db57600080fd5b600660205260009081526040902080546001820154600283015460038401805493949293919291610bd990611479565b80601f0160208091040260200160405190810160405280929190818152602001828054610c0590611479565b8015610c525780601f10610c2757610100808354040283529160200191610c52565b820191906000526020600020905b815481529060010190602001808311610c3557829003601f168201915b5050506004840154600585015460068601546007870154600888018054979894976001600160a01b03948516975092841695509216929190610c9390611479565b80601f0160208091040260200160405190810160405280929190818152602001828054610cbf90611479565b8015610d0c5780601f10610ce157610100808354040283529160200191610d0c565b820191906000526020600020905b815481529060010190602001808311610cef57829003601f168201915b505050505090806009018054610d2190611479565b80601f0160208091040260200160405190810160405280929190818152602001828054610d4d90611479565b8015610d9a5780601f10610d6f57610100808354040283529160200191610d9a565b820191906000526020600020905b815481529060010190602001808311610d7d57829003601f168201915b50505050509080600a015490508b565b60046020526000908152604090208054600182015460028301805492939192610dd290611479565b80601f0160208091040260200160405190810160405280929190818152602001828054610dfe90611479565b8015610e4b5780601f10610e2057610100808354040283529160200191610e4b565b820191906000526020600020905b815481529060010190602001808311610e2e57829003601f168201915b50505050600383015460049093015491926001600160a01b031691905085565b828054828255906000526020600020908101928215610ea6579160200282015b82811115610ea6578251825591602001919060010190610e8b565b50610eb2929150610eb6565b5090565b5b80821115610eb25760008155600101610eb7565b80356001600160a01b0381168114610ee257600080fd5b919050565b600080600060608486031215610efc57600080fd5b8335925060208401359150610f1360408501610ecb565b90509250925092565b600060208284031215610f2e57600080fd5b5035919050565b6020808252825182820181905260009190848201906040850190845b81811015610f6d57835183529284019291840191600101610f51565b50909695505050505050565b634e487b7160e01b600052604160045260246000fd5b604051601f8201601f1916810167ffffffffffffffff81118282101715610fb857610fb8610f79565b604052919050565b600082601f830112610fd157600080fd5b813567ffffffffffffffff811115610feb57610feb610f79565b610ffe601f8201601f1916602001610f8f565b81815284602083860101111561101357600080fd5b816020850160208301376000918101602001919091529392505050565b60008060006060848603121561104557600080fd5b83359250602084013567ffffffffffffffff8082111561106457600080fd5b61107087838801610fc0565b9350604086013591508082111561108657600080fd5b5061109386828701610fc0565b9150509250925092565b6000815180845260005b818110156110c3576020818501810151868301820152016110a7565b506000602082860101526020601f19601f83011685010191505092915050565b8381526060602082015260006110fc606083018561109d565b828103604084015261110e818561109d565b9695505050505050565b600082601f83011261112957600080fd5b8135602067ffffffffffffffff82111561114557611145610f79565b8160051b611154828201610f8f565b928352848101820192828101908785111561116e57600080fd5b83870192505b8483101561118d57823582529183019190830190611174565b979650505050505050565b60008060008060008060008060006101208a8c0312156111b757600080fd5b8935985060208a013567ffffffffffffffff808211156111d657600080fd5b6111e28d838e01611118565b995060408c0135985060608c01359150808211156111ff57600080fd5b61120b8d838e01610fc0565b975060808c0135965061122060a08d01610ecb565b955061122e60c08d01610ecb565b945060e08c013591508082111561124457600080fd5b6112508d838e01610fc0565b93506101008c013591508082111561126757600080fd5b506112748c828d01610fc0565b9150509295985092959850929598565b85815284602082015260a0604082015260006112a360a083018661109d565b6060830194909452506001600160a01b03919091166080909101529392505050565b600080604083850312156112d857600080fd5b50508035926020909101359150565b600080604083850312156112fa57600080fd5b8235915061130a60208401610ecb565b90509250929050565b600080600080600060a0868803121561132b57600080fd5b8535945060208601359350604086013567ffffffffffffffff81111561135057600080fd5b61135c88828901610fc0565b9350506060860135915061137260808701610ecb565b90509295509295909350565b60006101608d83528c60208401528b60408401528060608401526113a48184018c61109d565b608084018b90526001600160a01b038a811660a086015289811660c0860152881660e085015283810361010085015290506113df818761109d565b90508281036101208401526113f4818661109d565b915050826101408301529c9b505050505050505050505050565b85815284602082015260a06040820152600061142d60a083018661109d565b6001600160a01b0394909416606083015250608001529392505050565b634e487b7160e01b600052601160045260246000fd5b808201808211156114735761147361144a565b92915050565b600181811c9082168061148d57607f821691505b6020821081036114ad57634e487b7160e01b600052602260045260246000fd5b50919050565b601f8211156114fd57600081815260208120601f850160051c810160208610156114da5750805b601f850160051c820191505b818110156114f9578281556001016114e6565b5050505b505050565b815167ffffffffffffffff81111561151c5761151c610f79565b6115308161152a8454611479565b846114b3565b602080601f831160018114611565576000841561154d5750858301515b600019600386901b1c1916600185901b1785556114f9565b600085815260208120601f198616915b8281101561159457888601518255948401946001909101908401611575565b50858210156115b25787850151600019600388901b60f8161c191681555b5050505050600190811b01905550565b634e487b7160e01b600052603260045260246000fd5b6000600182016115ea576115ea61144a565b506001019056fea264697066735822122017597645c0e99767450748ebe0fe04a3383ee48e027cd44a398925ae67703ce064736f6c63430008110033",
  "linkReferences": {},
  "deployedLinkReferences": {}
}


// let contractAddress ="0xEEd5B8edC86013C360E87Ff39a28159DdDC1D9e8"; V1
let contractAddress ="0x433689100038DC94E44F90f75D82cB8230Da4Eb4"; // V2 
let contract;
app.use(express.json()); 

const connectToMatic = async () => {
  try {    
    // const provider = new ethers.providers.InfuraProvider(network, infuraKey);
    const provider = new ethers.providers.JsonRpcProvider("https://rpc-mumbai.maticvigil.com");
    // console.log(provider);  
    const signer = new ethers.Wallet(process.env.PRIVATEKEY, provider);  
    // console.log(signer);   
    const contractInstance = new ethers.Contract(contractAddress, contractAbi.abi, signer);
    contract =contractInstance;
    // console.log(await contractInstance.getAllProductTemplateIDs())
    // const tx =await contractInstance.addProductTemplate(1234132,"Tommy Hilfiger Watch","Men Black Analogue Watch Black");
    // const tx =await contractInstance.batchProduced(                                      
    //   363618,// batchID                                                 
    //   [477173,382171], // Array of product Ids               
    //   2,// Batch Size                                               
    //   "Batch of 3 Jeans",// Batch Description                                        
    //   1234132,// Product temlplate ID                                    
    //   "0x8626f6940E2eb28930eFb4CeF49B2d1F2C9C1199",// factory address     
    //   "0xdD2FD4581271e230360230F9337D5c0430Bf44C0",// distributor address
    //   "My Factory location",// factory Location                                   
    //   "1223123"// dateOfProduction                                         
    // )   
    // await tx.wait(); 

  } catch (err) {
    console.log(err);
    throw new Error(err?.message || "Something Went Wrong");
  }
}


connectToMatic();


////////////////// API FOR DISTIBUTOR ////////////////////

app.get('/api/viewAvailableBatches', async (req, res) => {
  try {
    let result=[]; 
    const distibutor= req.query.distibutor;
    const IDs =await contract.getAllBatchIDs();
    
    for(let i=0; i<IDs.length; i++){ 
      const batchData =await contract.BatchMapping(IDs[i]);
      if(batchData.Distributor==distibutor && batchData.state==0){
        const productIDs= (await contract.getProductIdsForaBatch(IDs[i]));
        result.push({
          "batchID":IDs[i].toNumber(),
          "productIDs":productIDs ,
          "batchData":{
            BatchID :batchData[0].toNumber(),
            BatchSize :batchData[1].toNumber(),
            AmountSold :batchData[2].toNumber(),
            BatchDescription :batchData[3],
            ProductTemplateID: batchData[4].toNumber(),
            Factory:batchData[5],
            Distributor:batchData[6],
            Retailer:batchData[7],
            FactoryLocation:batchData[8],
            DateOfProduction:batchData[9],
            state:batchData[10].toNumber(),
          }
        })
      } 
    }
    if(result){
      res.status(200).json({status:"success", message:result});
    }else {
      res.status(200).json({status:"success", message:"Returned data is empty"});
    }
  } catch (error) {
    console.log(error.message);
    res.status(400).send({ error: error.message });
  } 
});

app.post('/api/distributorSellToRetailer',async(req,res)=>{
  try {
    const batchID =req.body.batchID;
    const retailerAddress =req.body.retailerAddress;
    const tx =await contract.distributorSellToRetailer(batchID,retailerAddress);
    tx.wait();
    res.status(200).json({status:"success", message:"Batch sold to retailer"});
  } catch (error) {
    console.log(error.message);
    res.status(400).send({ error: error.message });
  }
})


app.get('/api/viewSendBatches', async (req, res) => {
  try {
    let result=[];
    const distibutor= req.query.distibutor;
    const IDs =await contract.getAllBatchIDs();
    for(let i=0; i<IDs.length; i++){
      const batchData =await contract.BatchMapping(IDs[i]);
      if(batchData.Distributor==distibutor && batchData.state==1){
        const productIDs= (await contract.getProductIdsForaBatch(IDs[i]));
        result.push({
          "batchID":IDs[i].toNumber(),
          "productIDs":productIDs ,
          "batchData":{
            BatchID :batchData[0].toNumber(),
            BatchSize :batchData[1].toNumber(),
            AmountSold :batchData[2].toNumber(),
            BatchDescription :batchData[3],
            ProductTemplateID: batchData[4].toNumber(),
            Factory:batchData[5],
            Distributor:batchData[6],
            Retailer:batchData[7],
            FactoryLocation:batchData[8],
            DateOfProduction:batchData[9],
            state:batchData[10].toNumber(),
          }
        })
      } 
    }
    if(result){
      res.status(200).json({status:"success", message:result});
    }else {
      res.status(200).json({status:"success", message:"Returned data is empty"});
    }
  } catch (error) {
    console.log(error.message);
    res.status(400).send({ error: error.message });
  } 
});



////////////////// API FOR RETAILER ////////////////////

app.get('/api/viewBatchesForRetailer', async (req, res) => {
  try {
    let result=[];
    const retailer= req.query.retailer;
    const IDs =await contract.getAllBatchIDs();
    for(let i=0; i<IDs.length; i++){
      const batchData =await contract.BatchMapping(IDs[i]);
      if(batchData.Retailer==retailer && batchData.state==1){
        let productInfo=[]; 
        const productIDs= await contract.getProductIdsForaBatch(IDs[i]);
        for(let j=0; j<productIDs.length; j++){
          productInfo.push(await contract.ProductMapping(productIDs[j]));
        }
        // console.log(productInfo[0]);
        result.push({
          "batchID":IDs[i].toNumber(),
          "productIDs":productIDs ,
          "batchData":{
            BatchID :batchData[0].toNumber(),
            BatchSize :batchData[1].toNumber(),
            AmountSold :batchData[2].toNumber(),
            BatchDescription :batchData[3],
            ProductTemplateID: batchData[4].toNumber(),
            Factory:batchData[5],
            Distributor:batchData[6],
            Retailer:batchData[7],
            FactoryLocation:batchData[8],
            DateOfProduction:batchData[9],
            state:batchData[10].toNumber(),
          },
          "productInfo":productInfo
        })
      } 
    }
    if(result){
      res.status(200).json({status:"success", message:result});
    }else {
      res.status(200).json({status:"success", message:"Returned data is empty"});
    }
  } catch (error) {
    console.log(error.message);
    res.status(400).send({ error: error.message });
  }
});   

app.post('/api/sellToCustomer',async(req,res)=>{
  try {
    const batchID =req.body.batchID;
    const productID =req.body.productID;
    const customerAddress =req.body.customerAddress;
    const tx =await contract.retailerSellToCustomer(batchID,productID,customerAddress);
    tx.wait();
    res.status(200).json({status:"success", message:"Product sold to customer"});
  } catch (error) {
    console.log(error.message);
    res.status(400).send({ error: error.message });
  }
})




////////////////// API FOR CUSTOMERS ////////////////////



app.get('/', function (req, res) {
    // console.log(web3)
    res.send('Hello World');
})
 
var server = app.listen(8082, function () {
    console.log("Example app listening at http://127:0:0:1:8082")
})